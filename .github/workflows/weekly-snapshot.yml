name: "Weekly Auto-Submission (Spring 2026)"

on:
  schedule:
    # Runs every Friday at 23:59 IST (18:29 UTC)
    - cron: '29 18 * * 5'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

env:
  # --- CONFIGURATION ---
  START_DATE: "2026-01-12" # Semester week 1 starts on this date (YYYY-MM-DD)
  TAG_PREFIX: "submission-week-"
  # Files that must show at least one commit touching them during the current week window.
  REQUIRED_WEEKLY_FILES: "docs/StatusTracker.xls docs/ProjectPlan.md"
  # Optional file students can edit to add human labels/categories to the weekly submission.
  # These will be copied into the tag annotation + release body.
  RELEASE_LABELS_FILE: "docs/release-labels.txt"
  # ---------------------

jobs:
  week-wise-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Semester Week
        id: calc
        run: |
          set -euo pipefail

          CURRENT_MONTH=$(date +%m)
          # Stop automatically after April
          if [ "$CURRENT_MONTH" -gt "04" ]; then
            echo "ACTIVE=false" >> $GITHUB_ENV
            exit 0
          fi

          START_SEC=$(date -d "$START_DATE" +%s)
          NOW_SEC=$(date +%s)
          WEEK_NUM=$(( ((NOW_SEC - START_SEC) / 604800) + 1 ))

          # Handle pre-semester dates
          if [ $WEEK_NUM -lt 1 ]; then WEEK_NUM=0; fi

          # Week window (inclusive start, exclusive end)
          WEEK_START_SEC=$(( START_SEC + (WEEK_NUM - 1) * 604800 ))
          WEEK_END_SEC=$(( WEEK_START_SEC + 604800 ))

          echo "WEEK_NUM=$WEEK_NUM" >> $GITHUB_ENV
          echo "WEEK_START_SEC=$WEEK_START_SEC" >> $GITHUB_ENV
          echo "WEEK_END_SEC=$WEEK_END_SEC" >> $GITHUB_ENV
          echo "TAG_NAME=${TAG_PREFIX}$WEEK_NUM" >> $GITHUB_ENV
          echo "ACTIVE=true" >> $GITHUB_ENV

      - name: Pre-flight checks (required files exist)
        if: env.ACTIVE == 'true'
        run: |
          set -euo pipefail

          for file in $REQUIRED_WEEKLY_FILES; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required weekly file not found: $file" >&2
              exit 1
            fi
          done

      - name: Verify previous snapshot integrity (tag/release not modified)
        if: env.ACTIVE == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ "$WEEK_NUM" -le 1 ]; then
            echo "No previous snapshot to verify (week $WEEK_NUM)."
            exit 0
          fi

          PREV_WEEK=$(( WEEK_NUM - 1 ))
          PREV_TAG="${TAG_PREFIX}${PREV_WEEK}"
          echo "Checking integrity of previous tag/release: $PREV_TAG"

          if ! git show-ref --verify --quiet "refs/tags/$PREV_TAG"; then
            echo "ERROR: Previous submission tag missing: $PREV_TAG" >&2
            exit 1
          fi

          # Extract annotated tag message.
          git cat-file -p "$PREV_TAG" > prev_tag.txt
          awk 'f{print} /^$/{f=1}' prev_tag.txt | tail -n +2 > prev_message.txt

          if [ ! -s prev_message.txt ]; then
            echo "ERROR: Previous submission tag is not an annotated tag: $PREV_TAG" >&2
            exit 1
          fi

          EXPECTED_SHA=$(sha256sum prev_message.txt | awk '{print $1}')

          # Fetch GitHub release body for the tag.
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${PREV_TAG}"
          curl -fsSL \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL" \
            > prev_release.json

          jq -r '.body // empty' prev_release.json > prev_release_body.txt

          if [ ! -s prev_release_body.txt ]; then
            echo "ERROR: Missing release body for previous submission tag" >&2
            exit 1
          fi

          ACTUAL_SHA=$(sha256sum prev_release_body.txt | awk '{print $1}')

          if [ "$EXPECTED_SHA" != "$ACTUAL_SHA" ]; then
            echo "ERROR: Previous release body differs from annotated tag message. Possible tampering." >&2
            echo "Expected SHA: $EXPECTED_SHA" >&2
            echo "Actual SHA:   $ACTUAL_SHA" >&2
            exit 1
          fi

          echo "Previous snapshot integrity OK."

      - name: Verify weekly updates (required files changed this week)
        if: env.ACTIVE == 'true'
        run: |
          set -euo pipefail

          # Ensure at least one commit in this week window touched each required weekly file.
          for file in $REQUIRED_WEEKLY_FILES; do
            echo "Checking weekly activity for: $file"
            if ! git log \
              --since="@${WEEK_START_SEC}" \
              --until="@${WEEK_END_SEC}" \
              --name-only \
              --pretty=format: \
              -- "$file" \
              | grep -q .
            then
              echo "ERROR: No commits touched $file during week $WEEK_NUM window." >&2
              echo "This will FAIL the weekly submission." >&2
              exit 1
            fi
          done

      - name: Build snapshot manifest (hashes + labels)
        if: env.ACTIVE == 'true'
        run: |
          set -euo pipefail

          echo "Building manifest for $TAG_NAME at $GITHUB_SHA"
          {
            echo "# Weekly Submission Snapshot"
            echo
            echo "tag: $TAG_NAME"
            echo "commit: $GITHUB_SHA"
            echo "generated_at_utc: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            echo "run_id: $GITHUB_RUN_ID"
            echo "run_attempt: $GITHUB_RUN_ATTEMPT"
            echo "week_num: $WEEK_NUM"
            echo

            if [ -f "$RELEASE_LABELS_FILE" ]; then
              echo "## Release labels / categories"
              cat "$RELEASE_LABELS_FILE"
              echo
            fi

            echo "## Git tags pointing at this commit"
            git tag --points-at "$GITHUB_SHA" | sed 's/^/- /' || true
            echo

            echo "## File hashes (sha256)"
          } > snapshot_manifest.txt

          # Hash all files under src/ and docs/ excluding junk.
          find src docs \
            -type f \
            ! -name '.DS_Store' \
            ! -name '~$*' \
            -print0 \
            | sort -z \
            | xargs -0 sha256sum \
            >> snapshot_manifest.txt

          echo >> snapshot_manifest.txt
          echo "manifest_sha256: $(sha256sum snapshot_manifest.txt | awk '{print $1}')" >> snapshot_manifest.txt

      - name: Create annotated git tag (immutable snapshot anchor)
        if: env.ACTIVE == 'true'
        run: |
          set -euo pipefail

          if git show-ref --verify --quiet "refs/tags/$TAG_NAME"; then
            echo "ERROR: Submission tag already exists: $TAG_NAME" >&2
            exit 1
          fi

          git tag -a "$TAG_NAME" -F snapshot_manifest.txt "$GITHUB_SHA"
          git push origin "refs/tags/$TAG_NAME"

      - name: Create GitHub release from tag
        if: env.ACTIVE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Week ${{ env.TAG_NAME }} Submission"
          body_path: snapshot_manifest.txt

