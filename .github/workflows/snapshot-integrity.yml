name: "Snapshot Integrity Monitor (Spring 2026)"

on:
  schedule:
    # Runs every Saturday at 00:30 IST (19:00 UTC Friday)
    - cron: '0 19 * * 5'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  TAG_PREFIX: "submission-week-"

jobs:
  verify-all-weeks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify all snapshot tags match their release bodies
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAGS=$(git tag -l "${TAG_PREFIX}*" | sort -V)
          if [ -z "$TAGS" ]; then
            echo "No snapshot tags found."
            exit 0
          fi

          echo "Found snapshot tags:" 
          echo "$TAGS"

          FAILURES=0
          for tag in $TAGS; do
            echo "---"
            echo "Verifying $tag"

            git cat-file -p "$tag" > tag_obj.txt
            awk 'f{print} /^$/{f=1}' tag_obj.txt | tail -n +2 > tag_message.txt
            if [ ! -s tag_message.txt ]; then
              echo "ERROR: Tag is not annotated (or message missing): $tag" >&2
              FAILURES=$((FAILURES+1))
              continue
            fi

            EXPECTED_SHA=$(sha256sum tag_message.txt | awk '{print $1}')

            API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${tag}"
            if ! curl -fsSL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API_URL" \
              > release.json
            then
              echo "ERROR: Missing GitHub release for tag: $tag" >&2
              FAILURES=$((FAILURES+1))
              continue
            fi

            jq -r '.body // empty' release.json > release_body.txt

            if [ ! -s release_body.txt ]; then
              echo "ERROR: Missing release body for tag: $tag" >&2
              FAILURES=$((FAILURES+1))
              continue
            fi

            ACTUAL_SHA=$(sha256sum release_body.txt | awk '{print $1}')

            if [ "$EXPECTED_SHA" != "$ACTUAL_SHA" ]; then
              echo "ERROR: Release body differs from annotated tag message for $tag" >&2
              echo "Expected SHA: $EXPECTED_SHA" >&2
              echo "Actual SHA:   $ACTUAL_SHA" >&2
              FAILURES=$((FAILURES+1))
            fi
          done

          if [ "$FAILURES" -gt 0 ]; then
            TITLE="Snapshot integrity check failed (${FAILURES})"
            BODY="One or more weekly snapshot releases/tags appear modified or missing.\n\nRun: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

            curl -fsSL \
              -X POST \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              -d "{\"title\":\"${TITLE}\",\"body\":\"${BODY}\"}" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues" \
              >/dev/null || true

            exit 1
          fi

          echo "All snapshots verified OK."
